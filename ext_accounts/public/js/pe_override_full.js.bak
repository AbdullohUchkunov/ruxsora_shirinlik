// ext_accounts/public/js/pe_override_full.js
// Payment Entry override for Расходы party type
console.log("[PE Override] Loaded - Variant 3 (JavaScript Bypass)");

frappe.ui.form.on("Payment Entry", {
  setup(frm) {
    // Protect Расходы from being cleared by ERPNext core
    protect_rashody_field(frm);
    
    // Setup queries
    frm.set_query("party_type", function () {
      return {
        query: "ext_accounts.overrides.payment_entry_queries.get_party_type",
      };
    });

    frm.set_query("party", function () {
      if (frm.doc.party_type === "Расходы") {
        // For Расходы, show 5200 expense accounts directly
        return {
          query: "ext_accounts.overrides.payment_entry_queries.get_party_for_rashody",
          filters: {
            company: frm.doc.company,
          },
        };
      }
      // Default party query
      return;
    });

    frm.set_query("paid_from", function () {
      return {
        filters: {
          account_type: ["in", ["Bank", "Cash"]],
          is_group: 0,
          company: frm.doc.company,
        },
      };
    });

    frm.set_query("paid_to", function () {
      return {
        filters: {
          account_type: ["in", ["Bank", "Cash"]],
          is_group: 0,
          company: frm.doc.company,
        },
      };
    });
  },

  onload(frm) {
    if (!frm.doc.payment_type && frm.doc.__islocal) {
      frm.set_value("payment_type", "Pay");
    }
    
    // Re-protect on load
    protect_rashody_field(frm);
  },

  refresh(frm) {
    toggle_rashody_fields(frm);
    protect_rashody_field(frm);
  },

  party_type(frm) {
    // Block ERPNext from clearing Расходы
    if (frm.doc.party_type === "Расходы") {
      setTimeout(() => {
        if (!frm.doc.party_type || frm.doc.party_type !== "Расходы") {
          frm.set_value("party_type", "Расходы");
        }
        toggle_rashody_fields(frm);
        frappe.show_alert({
          message: __("Select Expense Account from Party field"),
          indicator: "blue",
        });
      }, 100);
    } else {
      toggle_rashody_fields(frm);
    }
  },

  party(frm) {
    if (frm.doc.party_type === "Расходы" && frm.doc.party) {
      // Show selected account info
      frappe.db.get_value("Account", frm.doc.party, ["account_name", "account_currency"], function (r) {
        if (r) {
          frappe.show_alert({
            message: __("Selected: {0}", [r.account_name]),
            indicator: "green",
          });
        }
      });
    }
  },

  validate(frm) {
    if (frm.doc.party_type === "Расходы") {
      if (!frm.doc.party) {
        frappe.throw(__("Please select an Expense Account in Party field"));
      }
      
      if (frm.doc.payment_type === "Pay") {
        if (!frm.doc.paid_from || !frm.doc.paid_amount || frm.doc.paid_amount <= 0) {
          frappe.throw(__("Paid From and Paid Amount are mandatory"));
        }
      } else if (frm.doc.payment_type === "Receive") {
        if (!frm.doc.paid_to || !frm.doc.received_amount || frm.doc.received_amount <= 0) {
          frappe.throw(__("Paid To and Received Amount are mandatory"));
        }
      }
    }
  },
});

function toggle_rashody_fields(frm) {
  const is_rashody = frm.doc.party_type === "Расходы";

  // Party field always visible, but label changes
  frm.toggle_display("party", true);
  frm.toggle_reqd("party", is_rashody);
  
  if (is_rashody) {
    frm.set_df_property("party", "label", __("Expense Account (5200)"));
    frm.set_df_property("party", "description", __("Select expense account from 5200 - Indirect Expenses"));
  } else {
    frm.set_df_property("party", "label", __("Party"));
    frm.set_df_property("party", "description", "");
  }

  // Hide reference and advance sections for Расходы
  frm.toggle_display("references_section", !is_rashody);
  frm.toggle_display("party_balance", !is_rashody);
  frm.toggle_display("set_advances", !is_rashody);
  frm.toggle_display("advances_section", !is_rashody);
  frm.toggle_display("party_account", !is_rashody);
  
  // Clear references for Расходы
  if (is_rashody && frm.doc.references && frm.doc.references.length) {
    frm.clear_table("references");
    frm.refresh_field("references");
  }
}

// Critical: Protect Расходы from ERPNext core validation
function protect_rashody_field(frm) {
  if (frm._rashody_protected) return;
  
  // Override the party_type field's df to prevent ERPNext validation
  const party_type_field = frm.fields_dict.party_type;
  if (party_type_field) {
    const original_get_value = party_type_field.get_value.bind(party_type_field);
    
    party_type_field.get_value = function() {
      const val = original_get_value();
      // Always return the actual value, don't let ERPNext clear it
      return val;
    };
    
    // Prevent ERPNext from validating party_type against DocType
    const original_validate = party_type_field.validate;
    party_type_field.validate = function(value) {
      if (value === "Расходы") {
        // Skip validation for Расходы
        return value;
      }
      if (original_validate) {
        return original_validate.call(this, value);
      }
      return value;
    };
  }
  
  frm._rashody_protected = true;
}


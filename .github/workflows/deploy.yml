# ==============================================================================
# FRAPPE APP PRODUCTION DEPLOYMENT WORKFLOW (FIXED VERSION)
# ==============================================================================
# Author: Senior DevOps/Developer
# Description: Bu workflow mavjud Frappe ilovasini xavfsiz yangilaydi.
#
# TUZATISH (Fix):
# - Secret validatsiyasidagi syntax xatolik tuzatildi.
# - App nomi "ext_accounts" ga qat'iy biriktirilgan.
# ==============================================================================

name: Deploy to Production

# ------------------------------------------------------------------------------
# TRIGGER SOZLAMALARI
# ------------------------------------------------------------------------------
on:
  push:
    branches:
      - main              # main branchga kod tushganda ishlaydi
  workflow_dispatch:      # GitHub interfeysidan qo'lda ishlatish uchun

# ------------------------------------------------------------------------------
# GLOBAL O'ZGARUVCHILAR
# ------------------------------------------------------------------------------
env:
  # DIQQAT: Serverdagi papka nomini shu yerga yozing!
  APP_NAME: "ext_accounts"
  
  # Serverdagi yo'llar
  BENCH_PATH: "/home/frappe/frappe-bench"
  FRAPPE_USER: "frappe"

jobs:
  deploy:
    name: Production Server Update
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ------------------------------------------------------------------------
      # 1. KODNI TEKSHIRISH VA TAYYORLASH
      # ------------------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------------
      # 2. SSH KALITLARINI SOZLASH
      # ------------------------------------------------------------------------
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # ------------------------------------------------------------------------
      # 3. SIRLI MA'LUMOTLARNI (SECRETS) VALIDATSIYA QILISH (TUZATILDI)
      # ------------------------------------------------------------------------
      - name: Validate Secrets
        run: |
          # Oddiy va ishonchli tekshiruv
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "‚ùå ERROR: SERVER_IP secret not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SITE_NAME }}" ]; then
            echo "‚ùå ERROR: SITE_NAME secret not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_PRIVATE_KEY secret not set!"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      # ------------------------------------------------------------------------
      # 4. DEPLOYMENT STATUSINI TEKSHIRISH
      # ------------------------------------------------------------------------
      - name: Check Server Status
        id: check_deploy
        run: |
          if ssh root@${{ secrets.SERVER_IP }} "[ -d ${{ env.BENCH_PATH }} ]"; then
            echo "deployment_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frappe Bench found on server."
          else
            echo "deployment_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Frappe Bench not found!"
          fi

      # ------------------------------------------------------------------------
      # 5. ASOSIY UPDATE JARAYONI
      # ------------------------------------------------------------------------
      - name: Execute Server Update
        if: steps.check_deploy.outputs.deployment_exists == 'true'
        run: |
          echo "üöÄ Starting deployment for app: ${{ env.APP_NAME }}"
          
          ssh root@${{ secrets.SERVER_IP }} << ENDSSH
            set -e
            
            echo "üîí Logged in as root. Switching to frappe user..."
            
            # Frappe useriga o'tamiz
            su - ${FRAPPE_USER} << 'FRAPPE_EOF'
              set -e
              
              # O'zgaruvchilarni qabul qilish
              SITE_NAME="${{ secrets.SITE_NAME }}"
              BENCH_PATH="${{ env.BENCH_PATH }}"
              APP_DIR="${{ env.APP_NAME }}"  # "ext_accounts"
              GIT_BRANCH="${{ github.ref_name }}"
              
              echo "üìÇ Navigating to bench: \${BENCH_PATH}"
              cd \${BENCH_PATH}
              
              # App papkasi borligini tekshirish
              if [ ! -d "apps/\${APP_DIR}" ]; then
                echo "‚ùå Error: App folder 'apps/\${APP_DIR}' not found!"
                echo "Please install the app manually first using: bench get-app ..."
                exit 1
              fi
              
              echo "üîÑ Updating source code for: \${APP_DIR}"
              cd apps/\${APP_DIR}
              
              # Remote nomini aniqlash
              REMOTE_NAME=\$(git remote | head -1)
              echo "üîó Git Remote: \${REMOTE_NAME}"
              
              # Kodni yangilash
              git fetch \${REMOTE_NAME}
              git reset --hard \${REMOTE_NAME}/\${GIT_BRANCH}
              
              echo "‚úÖ Code updated to commit:"
              git log -1 --oneline
              
              # Orqaga - bench papkasiga qaytish
              cd \${BENCH_PATH}
              
              # 1. Python dependency
              echo "üì¶ Installing Requirements..."
              bench setup requirements --python || true
              
              # 2. Assets qurish
              echo "üé® Building Assets..."
              bench build --app \${APP_DIR}
              
              # 3. Migratsiya
              echo "üóÑÔ∏è Migrating Database..."
              bench --site \${SITE_NAME} migrate
              
              # 4. Keshni tozalash
              echo "üßπ Clearing Cache..."
              bench --site \${SITE_NAME} clear-cache
              bench --site \${SITE_NAME} clear-website-cache
              
              echo "‚úÖ Frappe User Tasks Completed!"
            FRAPPE_EOF
            
            # Root huquqlari bilan servislarni restart qilish
            echo "üîÑ Restarting System Services..."
            supervisorctl restart all
            systemctl reload nginx || true
            
            echo "‚úÖ DEPLOYMENT FINISHED SUCCESSFULLY!"
          ENDSSH

      # ------------------------------------------------------------------------
      # 6. YAKUNIY TEKSHIRUV (HEALTH CHECK)
      # ------------------------------------------------------------------------
      - name: Verify Deployment
        if: success()
        run: |
          echo "üè• Performing Health Check..."
          sleep 15
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_IP }} || echo "000")
          echo "üåê Site Status Code: $HTTP_CODE"
          
          if [[ "$HTTP_CODE" =~ ^(200|301|302)$ ]]; then
             echo "‚úÖ Site is UP and Running!"
          else
             echo "‚ö†Ô∏è Warning: Site check returned $HTTP_CODE (Check Nginx logs)"
          fi

      # ------------------------------------------------------------------------
      # 7. NOTIFIKATSIYA (LOG)
      # ------------------------------------------------------------------------
      - name: Deployment Summary
        if: always()
        run: |
          echo "========================================="
          echo "App: ${{ env.APP_NAME }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Status: ${{ job.status }}"
          echo "========================================="